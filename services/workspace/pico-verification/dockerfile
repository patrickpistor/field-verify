FROM rust:latest

# Install dependencies
RUN apt-get update && \
    apt-get install -y git build-essential

# Install specific nightly version required by Pico
RUN rustup install nightly-2024-11-27 && \
    rustup default nightly-2024-11-27 && \
    rustup component add rust-src --toolchain nightly-2024-11-27

# Install Pico CLI
WORKDIR /tmp
RUN git clone https://github.com/brevis-network/pico
WORKDIR /tmp/pico/sdk/cli
RUN cargo install --locked --force --path .

# Set default working directory 
WORKDIR /project

# Copy the entire verification-app directory
COPY ../verification-app /project/verification-app

# Verify contents
RUN pwd && ls -la /project/verification-app/app && find /project -name "Cargo.toml"

# Set working directory for build
WORKDIR /project/verification-app/app

# Build the RISC-V verification app
RUN cargo pico build

WORKDIR /project/pico-verification

# This ensures the API starts when the container starts
CMD ["cargo", "run", "--release", "--", "--api", "--output", "/project/output", "--port", "3000"]